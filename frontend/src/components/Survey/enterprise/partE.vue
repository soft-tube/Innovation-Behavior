<template>
    <el-card style="border-radius: 15px;width: 100%;">
        <el-form :model="form" size="large" label-position="top">
            <el-form-item class="question" style="font-weight: bolder;" label="E01.ÊÇ®Â¶Ç‰ΩïËØÑ‰ª∑ËøáÂéª‰∫îÂπ¥ÁöÑÁü•ËØÜ‰∫ßÊùÉËê•ÂïÜÁéØÂ¢ÉÔºü">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ÔºàËØ∑ÊâìÂàÜÔºå1üåü‰∏∫ÈùûÂ∏∏Â∑ÆÔºå5üåü‰∏∫ÈùûÂ∏∏Â•ΩÔºâ" />
                <el-table :data="tablePEQ01" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="300%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="200%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ01" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate[colIndex]"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ01(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

            <el-form-item class="question" style="font-weight: bolder;" label="E02.ÊÇ®ÊòØÂê¶‰∫ÜËß£‰ª•‰∏ã‰∏ìÂà©ËÆ∏ÂèØÊú∫Âà∂Ôºü">
                <el-table :data="tablePEQ2" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="200%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="150%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ2" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <!-- Âú®ÊØè‰∏™ÂçïÂÖÉÊ†ºÂÜÖÊîæÁΩÆ‰∏Ä‰∏™ÂèØÈÄâ‰∏≠ÁöÑÁªÑ‰ª∂ -->
                            <el-checkbox class="table-container1" v-model="row.selection[colIndex]"
                                @change="handlePEQ2(row, colIndex)"></el-checkbox>
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>
            <el-form-item class="question" style="font-weight: bolder;" label="E03.Ë¥µÂè∏ÊòØÂê¶ÂèÇÂä†Ëøá‰ª•‰∏ã‰∏ìÂà©ËøêËê•Áõ∏ÂÖ≥ÊúçÂä°Ôºü">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ÔºàËØ∑ÊâìÂàÜÔºå1üåü‰∏∫Ê≤°ÊúâÔºå5üåü‰∏∫ËÆ∏Â§öÊ¨°Ôºâ" />
                <el-table :data="tablePEQ3" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="350%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ3" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ03(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>
            <el-form-item class="question" style="font-weight: bolder;" label="E04.Ë¥µÂè∏ÊòØÂê¶Ëé∑ÂæóËøá‰ª•‰∏ã‰∏ìÂà©ËøêËê•Áõ∏ÂÖ≥ÁöÑÊîøÁ≠ñËµÑÂä©Ôºü">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ÔºàËØ∑ÊâìÂàÜÔºå1üåü‰∏∫Ê≤°ÊúâÔºå5üåü‰∏∫ËÆ∏Â§öÊ¨°Ôºâ" />
                <el-table :data="tablePEQ4" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="250%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ4" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ04(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

            <el-form-item class="question" style="font-weight: bolder;" label="E05.ÊÇ®ËÆ§‰∏∫ÊîøÂ∫úÂ∫îÂΩìÊèêÂçá‰ª•‰∏ãÂì™Âá†Á±ªÂÖ¨ÂÖ±ÊúçÂä°ÁöÑÊäïÂÖ•Ôºü">
                <el-form-item class="question blue-label" style="font-weight: bolder;"
                    label="ÔºàËØ∑ÊâìÂàÜÔºå1üåü‰∏∫‰∏çÁî®ÊèêÈ´òÔºå5üåü‰∏∫Â§ßÂπÖÊèêÈ´òÔºâ" />
                <el-table :data="tablePEQ5" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="400%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ5" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ05(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

        </el-form>
        <el-button type="primary" @click="submit()" style="margin-top: 1vh;margin-left: 2vw;">Êèê‰∫§ÈóÆÂç∑ÔºàEÈÉ®ÂàÜÔºâ</el-button>

        <el-dialog style="font-family: SimSun;width: 40vw;align-items: center;justify-content: center;" title="Á∫™ÂøµÂìÅÈ¢ÜÂèñ"
            v-model="dialogVisible" :before-close="handleClose">
            <el-card style="gap: 6px;border: none;align-items: center;justify-content: center;display: flex;"
                shadow="never">
                <el-container style="margin-bottom: 2vh;">‰∏∫ÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºåÊàë‰ª¨‰∏∫ÊÇ®ÂáÜÂ§á‰∫Ü‰∏Ä‰ªΩÁ∫™ÂøµÂìÅ„ÄÇ</el-container>
                <el-container>
                    <el-image :src="award"></el-image>
                </el-container>
                <el-container style="margin-top: 2vh">
                    ÊÇ®ÂèØ‰ª•ÈÄâÊã©:
                </el-container>
                <el-radio-group v-model="awardForm.award">
                    <el-radio class="answer" label="Áõ¥Êé•Ëé∑Âæó‰∏Ä‰ªΩÁ∫™ÂøµÂìÅ" />
                    <el-radio class="answer" label="ÈÄâÊã©ÊäõÁ°¨Â∏ÅÊ∏∏ÊàèÔºöÂ¶ÇÊûúÊäõÂá∫Ê≠£Èù¢ÔºåËé∑Âæó‰∏§‰ªΩÁ∫™ÂøµÂìÅ„ÄÇ" />
                </el-radio-group>
            </el-card>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary" @click="submitAward">
                        Á°ÆËÆ§
                    </el-button>
                </div>
            </template>
        </el-dialog>
    </el-card>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { surveyStore,tableColChange } from '../../../stores/survey';
import axios from 'axios';
import { ElMessage } from 'element-plus';
import award from '../../../public/img/award.png'
const surveyInfo = surveyStore().surveyInfo
const form = reactive({
    pEq01: [],
    pEq02: [],
    pEq03: [],
    pEq04: [],
    pEq05: [],
});

const awardForm = reactive({
    patentNo: "",
    award:"",
    address:""
})

const dialogVisible = ref(false)

//‰ª•‰∏ãÂÆûÁé∞ÊâÄÊúâË°®Ê†º
const tablePEQ01 = ref([
    { name: "‰∏ìÂà©ÁöÑÂÆ°Êü•ÊïàÁéá", rate: [0,0] },
    { name: "‰∏ìÂà©Áî≥ËØ∑Ê≥®ÂÜåËøáÁ®ã‰∏≠ÁöÑ‰ø°ÊÅØÁ≥ªÁªü‰æøÂà©Á®ãÂ∫¶", rate: [0, 0] },
    { name: "‰∏ìÂà©Áî≥ËØ∑ÁöÑÊàêÊú¨ÔºàÂåÖÂê´Áî≥ËØ∑Ë¥π„ÄÅ‰ª£ÁêÜË¥πÔºâ", rate: [0, 0] },
    { name: "‰∏ìÂà©ËØâËÆºÊàêÊú¨ÔºàÂåÖÂê´ÂæãÂ∏àË¥πÁ≠âÔºâ", rate: [0, 0] },
    { name: "‰∏ìÂà©‰øùÊä§ÁöÑÂäõÂ∫¶ÔºàÂ¶ÇÊÉ©ÁΩöÊÄßËµîÂÅøÈ¢ùÂ∫¶Á≠âÔºâ", rate: [0, 0] },
    { name: "ÂØπÂæÖ‰∏çÂêåÂàõÊñ∞‰∏ª‰ΩìÔºå‰∏ìÂà©ÂÆ°Êü•ÂÜ≥ÂÆöÁöÑÂÖ¨Âπ≥ÊÄß", rate: [0, 0] },
    { name: "ÂØπÂæÖ‰∏çÂêåÂàõÊñ∞‰∏ª‰ΩìÔºå‰∏ìÂà©‰æµÊùÉË£ÅÂÜ≥„ÄÅË°åÊîøÊâßÊ≥ïÁöÑÂÖ¨Âπ≥ÊÄß", rate: [0, 0] },
]);

const colPEQ01 = [
    { label: "2018" },
    { label: "2023" }
];

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÈÄâ‰∏≠Áä∂ÊÄÅÂèòÂåñ
const handlePEQ01 = (row, colIndex) => {
    // ÂèñÊ∂àÂΩìÂâçË°åÂÖ∂‰ªñÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    form.pEq01 = tablePEQ01
};

const tablePEQ2 = ref([
    { name: "ÁâπÊñØÊãâÁöÑ‰∏ìÂà©ÂºÄÊîæ",selection: [false, false, false] },
    { name: "‰∏ìÂà©ËÆ∏ÂèØÂ§áÊ°àÂà∂Â∫¶",selection: [false, false, false] },
    { name: "‰∏ìÂà©Ë±ÅÂÖç",selection: [false, false, false] },
    { name: "‰∏ìÂà©Âº∫Âà∂ËÆ∏ÂèØÂà∂Â∫¶",selection: [false, false, false] },
    { name: "‰∏ìÂà©ÂºÄÊîæËÆ∏ÂèØÂà∂Â∫¶",selection: [false, false, false] },
    { name: "ËçØÂìÅ‰∏ìÂà©Ê±† MPP", selection: [false, false, false] },
    { name: "ÂåªËçØ‰∏ìÂà©ÈìæÊé•Âà∂Â∫¶", selection: [false, false, false] },
    { name: "Ê†áÂáÜÂøÖË¶Å‰∏ìÂà©", selection: [false, false, false] },
]);

const colPEQ2 = [
    { label: "ÂèÇ‰∏éËøá" },
    { label: "‰∫ÜËß£ÔºåÊ≤°ÂèÇ‰∏éËøá" },
    { label: "‰∏çÂ§™‰∫ÜËß£" },
];

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÈÄâ‰∏≠Áä∂ÊÄÅÂèòÂåñ
const handlePEQ2 = (row, colIndex) => {
    const rowIndex = tablePEQ2.value.indexOf(row);
    tableColChange(tablePEQ2.value,rowIndex,colIndex)    
    form.pEq02 = tablePEQ2
};

const tablePEQ3 = ref([
    { name: "ÂèÇÂä†ÊèêÂçáÁü•ËØÜ‰∫ßÊùÉËøêËê•ËÉΩÂäõÁöÑÂüπËÆ≠/ÂÖ¨ÁõäËÆ≤Â∫ß",rate: 0 },
    { name: "ÂèÇÂä†Áü•ËØÜ‰∫ßÊùÉËøêËê•ÊîøÁ≠ñÁöÑÊîøÁ≠ñÂí®ËØ¢ËÆ≤Â∫ß", rate: 0 },
    { name: "ÂèÇÂä†‰∏ìÂà©ÊäÄÊúØÁöÑË∑ØÊºîÊé®‰ªãÊ¥ªÂä®", rate: 0 },
    { name: "‰ΩøÁî®ÂÖ¨ÂÖ±ÈÉ®Èó®Êê≠Âª∫ÁöÑ‰∏ìÂà©Âú®Á∫ø‰∫§ÊòìÂπ≥Âè∞", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©ËÆ∏ÂèØ‰∫§ÊòìÁöÑÂÆö‰ª∑ÊåáÂØº", rate: 0 },
]);

const colPEQ3 = [
    { label: "Ê≤°Êúâ-->ËÆ∏Â§öÊ¨°" },
];

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÈÄâ‰∏≠Áä∂ÊÄÅÂèòÂåñ
const handlePEQ03 = (row, colIndex) => {
    // ÂèñÊ∂àÂΩìÂâçË°åÂÖ∂‰ªñÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    form.pEq03 = tablePEQ3
};

const tablePEQ4 = ref([
    { name: "Ëé∑ÂæóÈ´ò‰ª∑ÂÄº‰∏ìÂà©ÁöÑÂ•ñÂä±", rate: 0 },
    { name: "Ëé∑ÂæóÁü•ËØÜ‰∫ßÊùÉËØïÁÇπÁ§∫ËåÉÈ°πÁõÆÂ•ñÂä±", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©ËΩ¨ÂåñÊàêÊûúÂ•ñÂä±", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©Áª≠Ë¥πÁöÑÂáèÂÖçÊàñË°•Ë¥¥", rate: 0 },
    { name: "‰∫´ÂèóÁ†îÂèëË¥πÁî®ÁöÑÂä†ËÆ°Êâ£Èô§", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©ËÆ∏ÂèØÊî∂ÁõäÁõ∏ÂÖ≥ÁöÑÁ®éÊî∂ÂáèÂÖç", rate: 0 },
]);

const colPEQ4 = [
    { label: "Ê≤°Êúâ-->ËÆ∏Â§öÊ¨°" },
];

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÈÄâ‰∏≠Áä∂ÊÄÅÂèòÂåñ
const handlePEQ04 = (row, colIndex) => {
    // ÂèñÊ∂àÂΩìÂâçË°åÂÖ∂‰ªñÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    form.pEq04 = tablePEQ4
};

const tablePEQ5 = ref([
    { name: "‰∏æÂäûÁü•ËØÜ‰∫ßÊùÉËøêËê•ËÉΩÂäõÁöÑÂüπËÆ≠/ÂÖ¨ÁõäËÆ≤Â∫ß", rate: 0 },
    { name: "‰∏æÂäûÁü•ËØÜ‰∫ßÊùÉËøêËê•ÊîøÁ≠ñÁöÑÊîøÁ≠ñÂí®ËØ¢ËÆ≤Â∫ß", rate: 0 },
    { name: "ÂèëÂ∏ÉËØ∏Â¶Ç„Ää‰∏ìÂà©ÂºÄÊîæËÆ∏ÂèØ‰ΩøÁî®Ë¥π‰º∞ÁÆóÊåáÂºï„ÄãÁ≠âÊåáÂØºÊâãÂÜå", rate: 0 },
    { name: "‰∏æÂäû‰∏ìÂà©ÊäÄÊúØÁöÑË∑ØÊºîÊé®‰ªãÊ¥ªÂä®", rate: 0 },
    { name: "Êèê‰æõ„ÄÅÊê≠Âª∫‰∏ìÂà©Âú®Á∫ø‰∫§ÊòìÂπ≥Âè∞", rate: 0 },
    { name: "Êèê‰æõ‰∏ìÂà©ËÆ∏ÂèØ‰∫§ÊòìÁöÑÂÖ¨ÁõäÊÄßÂÆö‰ª∑ÊåáÂØº", rate: 0 },
    { name: "Êèê‰æõÁªôÈ´ò‰ª∑ÂÄº‰∏ìÂà©ÁöÑÂ•ñÂä±", rate: 0 },
    { name: "Êèê‰æõ‰∏ìÂà©ËΩ¨ÁßªËΩ¨ÂåñÊàêÊûúÂ•ñÂä±", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©Áª≠Ë¥πÁöÑÂáèÂÖçÊàñË°•Ë¥¥", rate: 0 },
    { name: "‰∫´ÂèóÁ†îÂèëË¥πÁî®ÁöÑÂä†ËÆ°Êâ£Èô§", rate: 0 },
    { name: "Ëé∑Âæó‰∏ìÂà©ËÆ∏ÂèØÊî∂ÁõäÁõ∏ÂÖ≥ÁöÑÁ®éÊî∂ÂáèÂÖç", rate: 0 },
]);

const colPEQ5 = [
    { label: "‰∏çÁî®ÊèêÈ´ò-->Â§ßÂπÖÊèêÈ´ò" },
];

// Â§ÑÁêÜÂçïÂÖÉÊ†ºÈÄâ‰∏≠Áä∂ÊÄÅÂèòÂåñ
const handlePEQ05 = (row, colIndex) => {
    // ÂèñÊ∂àÂΩìÂâçË°åÂÖ∂‰ªñÂçïÂÖÉÊ†ºÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
    form.pEq05 = tablePEQ5
};
const changeTable = (table, col) => {
    let results = [];
    for (let i = 0; i < table.length; i++) {
        for (let j = 0; j < table[i].selection.length; j++) {
            if (table[i].selection[j]) {
                results.push({ row: table[i].name, col: col[j].label });
            }
        }
    }
    return results
}
const submit = async () => {
    // Ê∑±Êã∑Ë¥ù
    let formData = JSON.parse(JSON.stringify(form));
    formData.pEq02=changeTable(formData.pEq02,colPEQ2)
    // Â∞ÜË°®ÂçïÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÂØπË±°Êï∞ÁªÑ
    const formDataArray = Object.entries(formData).map(([key, value]) => ({ [key]: value }));

    // Â∞ÜÂØπË±°Êï∞ÁªÑÂ≠óÁ¨¶‰∏≤Âåñ
    const formDataString = JSON.stringify(formDataArray);

    const patentNo = surveyInfo.patentNo

    console.log(patentNo)
    console.log(formDataString);


    const invitationCode = surveyInfo.curInvitationCode

    const data = {
        invitationCode: invitationCode,
        patentNo: patentNo,
        policy: formDataString
    };
    let response = await axios.post('/api/survey/policy', data);
    if (response.status == 200) {
        if (response.data.code == 1) {
            ElMessage.success("submit successfully")
            dialogVisible.value = true
        }
    }
}
const submitAward = async () => {
    awardForm.patentNo = surveyInfo.patentNo
    dialogVisible.value = false
    console.log(awardForm)
    let response = await axios.post('/api/survey/award', awardForm);
    if (response.status == 200) {
        if (response.data.code == 1) {
            ElMessage.success("ÊàêÂäüÊèê‰∫§Â•ñÂä±")
        } else{
            ElMessage.error("ÊÇ®Â∑≤ÈÄâÊã©Â•ñÂä±")
        }
    }
}
</script>

<style scoped>
:deep(.el-radio__label) {
    white-space: normal;
    /* Êç¢Ë°å */
}

:deep(.el-checkbox__label) {
    white-space: normal;
    /* Êç¢Ë°å */
}
.question {
    font-weight: bolder;
    font-family: SimSun;
}

.answer {
    font-family: KaiTi;
    margin-left: 2em;
}

.table-container {
    display: flex;
    margin-left: 2vw;
}
.table-container1 {
    display: flex;
    justify-content: center;

    align-items: center;

}
.el-table {
    margin-left: 2.5em;
    margin-top: 1vh;
}

::v-deep.el-table th {
    border: 1px solid rgb(105, 102, 102) !important;
    border-right: none !important;
    border-bottom: none !important;
    border-top: none !important;
    /* border-left: none !important; */
}

::v-deep.el-table td {
    border: 1px solid rgb(105, 102, 102);
    border-right: none !important;
    border-bottom: none !important;
    /* border-left: none !important; */
}

::v-deep .el-table {
    border-collapse: separate;
    border: none !important;
}

.ps{
    color: rgb(0,112,192);
}
::v-deep .el-form-item__label {
    font-size: 17px;

}
</style>
