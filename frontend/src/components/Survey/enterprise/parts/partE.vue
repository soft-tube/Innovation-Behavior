<template>
    <el-card style="border-radius: 15px;width: 100%;">
        <el-form :model="form" size="large" label-position="top">
            <el-form-item class="question" style="font-weight: bolder;" label="E01.æ‚¨å¦‚ä½•è¯„ä»·è¿‡å»äº”å¹´çš„çŸ¥è¯†äº§æƒè¥å•†ç¯å¢ƒï¼Ÿ">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ï¼ˆè¯·æ‰“åˆ†ï¼Œ1ğŸŒŸä¸ºéå¸¸å·®ï¼Œ5ğŸŒŸä¸ºéå¸¸å¥½ï¼‰" />
                <el-table :data="tablePEQ01" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="300%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="200%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ01" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate[colIndex]"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ01(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

            <el-form-item class="question" style="font-weight: bolder;" label="E02.æ‚¨æ˜¯å¦äº†è§£ä»¥ä¸‹ä¸“åˆ©è®¸å¯æœºåˆ¶ï¼Ÿ">
                <el-table :data="tablePEQ2" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="200%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="150%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ2" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <!-- åœ¨æ¯ä¸ªå•å…ƒæ ¼å†…æ”¾ç½®ä¸€ä¸ªå¯é€‰ä¸­çš„ç»„ä»¶ -->
                            <el-checkbox class="table-container1" v-model="row.selection[colIndex]"
                                @change="handlePEQ2(row, colIndex)"></el-checkbox>
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>
            <el-form-item class="question" style="font-weight: bolder;" label="E03.è´µå¸æ˜¯å¦å‚åŠ è¿‡ä»¥ä¸‹ä¸“åˆ©è¿è¥ç›¸å…³æœåŠ¡ï¼Ÿ">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ï¼ˆè¯·æ‰“åˆ†ï¼Œ1ğŸŒŸä¸ºæ²¡æœ‰ï¼Œ5ğŸŒŸä¸ºè®¸å¤šæ¬¡ï¼‰" />
                <el-table :data="tablePEQ3" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="350%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ3" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ03(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>
            <el-form-item class="question" style="font-weight: bolder;" label="E04.è´µå¸æ˜¯å¦è·å¾—è¿‡ä»¥ä¸‹ä¸“åˆ©è¿è¥ç›¸å…³çš„æ”¿ç­–èµ„åŠ©ï¼Ÿ">
                <el-form-item class="question blue-label" style="font-weight: bolder;" label="ï¼ˆè¯·æ‰“åˆ†ï¼Œ1ğŸŒŸä¸ºæ²¡æœ‰ï¼Œ5ğŸŒŸä¸ºè®¸å¤šæ¬¡ï¼‰" />
                <el-table :data="tablePEQ4" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="250%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ4" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ04(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

            <el-form-item class="question" style="font-weight: bolder;" label="E05.æ‚¨è®¤ä¸ºæ”¿åºœåº”å½“æå‡ä»¥ä¸‹å“ªå‡ ç±»å…¬å…±æœåŠ¡çš„æŠ•å…¥ï¼Ÿ">
                <el-form-item class="question blue-label" style="font-weight: bolder;"
                    label="ï¼ˆè¯·æ‰“åˆ†ï¼Œ1ğŸŒŸä¸ºä¸ç”¨æé«˜ï¼Œ5ğŸŒŸä¸ºå¤§å¹…æé«˜ï¼‰" />
                <el-table :data="tablePEQ5" style="width: 100%" :row-style="{ height: '10px' }"
                    :cell-style="{ padding: '0px' }">
                    <el-table-column class="answer" width="400%">
                        <template #default="{ row }">
                            {{ row.name }}
                        </template>
                    </el-table-column>
                    <el-table-column width="250%" class="answer" header-align="center"
                        v-for="(column, colIndex) in colPEQ5" :key="colIndex" :label="column.label">
                        <template #default="{ row }">
                            <el-rate text-color="#ff9900" size="large" v-model="row.rate"
                                :texts="['not', 'so-so', 'relative', 'very', 'super']" show-text class="table-container"
                                @change="handlePEQ05(row, colIndex)" />
                        </template>
                    </el-table-column>
                </el-table>
            </el-form-item>

        </el-form>
        <el-button type="primary" @click="submit()" style="margin-top: 1vh;margin-left: 2vw;">æäº¤é—®å·ï¼ˆEéƒ¨åˆ†ï¼‰</el-button>

        <el-dialog style="font-family: SimSun;width: 40vw;align-items: center;justify-content: center;" title="çºªå¿µå“é¢†å–"
            v-model="dialogVisible" :before-close="handleClose">
            <el-card style="gap: 6px;border: none;align-items: center;justify-content: center;display: flex;"
                shadow="never">
                <el-container style="margin-bottom: 2vh;">
                    <el-text style="line-height: 5vh;">æ„Ÿè°¢æ‚¨çš„é…åˆä¸æ”¯æŒï¼Œè¯·å¡«å†™æ‚¨çš„é‚®å¯„æ–¹å¼æˆ–è”ç³»æˆ‘ä»¬<span
                            style="color: blue;">ï¼ˆopi_survey@tongji.edu.cnï¼‰</span>ï¼Œæˆ‘ä»¬å°†é‚®å¯„çºªå¿µå“å’–å•¡æ¯ä¸€ä»½ã€‚</el-text></el-container>
                <el-container>
                    <el-image :src="award"></el-image>
                </el-container>
                <!-- <el-container style="margin-top: 2vh">
                    æ‚¨å¯ä»¥é€‰æ‹©:
                </el-container>
                <el-radio-group v-model="awardForm.award">
                    <el-radio class="answer" label="ç›´æ¥è·å¾—ä¸€ä»½çºªå¿µå“" />
                    <el-radio class="answer" label="é€‰æ‹©æŠ›ç¡¬å¸æ¸¸æˆï¼šå¦‚æœæŠ›å‡ºæ­£é¢ï¼Œè·å¾—ä¸¤ä»½çºªå¿µå“ã€‚" />
                </el-radio-group> -->
                <el-container style="margin-top: 2vh">
                    <el-text>è¯·è¾“å…¥é‚®å¯„åœ°å€</el-text>
                    <el-input v-model="awardForm.address" style="width: 60%;margin-left: 2vw;"></el-input>
                </el-container>
            </el-card>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="submitAward">
                        ç¡®è®¤
                    </el-button>
                </div>
            </template>
        </el-dialog>
    </el-card>
</template>

<script setup>
import { ref, reactive } from 'vue';
import { surveyStore,tableColChange } from '../../../../stores/survey';
import axios from 'axios';
import { ElMessage } from 'element-plus';
import award from '../../../../public/img/award.png'
const surveyInfo = surveyStore().surveyInfo
const form = reactive({
    pEq01: [],
    pEq02: [],
    pEq03: [],
    pEq04: [],
    pEq05: [],
});

const awardForm = reactive({
    patentNo: "",
    award:"",
    address:""
})

const dialogVisible = ref(false)

//ä»¥ä¸‹å®ç°æ‰€æœ‰è¡¨æ ¼
const tablePEQ01 = ref([
    { name: "ä¸“åˆ©çš„å®¡æŸ¥æ•ˆç‡", rate: [0,0] },
    { name: "ä¸“åˆ©ç”³è¯·æ³¨å†Œè¿‡ç¨‹ä¸­çš„ä¿¡æ¯ç³»ç»Ÿä¾¿åˆ©ç¨‹åº¦", rate: [0, 0] },
    { name: "ä¸“åˆ©ç”³è¯·çš„æˆæœ¬ï¼ˆåŒ…å«ç”³è¯·è´¹ã€ä»£ç†è´¹ï¼‰", rate: [0, 0] },
    { name: "ä¸“åˆ©è¯‰è®¼æˆæœ¬ï¼ˆåŒ…å«å¾‹å¸ˆè´¹ç­‰ï¼‰", rate: [0, 0] },
    { name: "ä¸“åˆ©ä¿æŠ¤çš„åŠ›åº¦ï¼ˆå¦‚æƒ©ç½šæ€§èµ”å¿é¢åº¦ç­‰ï¼‰", rate: [0, 0] },
    { name: "å¯¹å¾…ä¸åŒåˆ›æ–°ä¸»ä½“ï¼Œä¸“åˆ©å®¡æŸ¥å†³å®šçš„å…¬å¹³æ€§", rate: [0, 0] },
    { name: "å¯¹å¾…ä¸åŒåˆ›æ–°ä¸»ä½“ï¼Œä¸“åˆ©ä¾µæƒè£å†³ã€è¡Œæ”¿æ‰§æ³•çš„å…¬å¹³æ€§", rate: [0, 0] },
]);

const colPEQ01 = [
    { label: "2018" },
    { label: "2023" }
];

// å¤„ç†å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€å˜åŒ–
const handlePEQ01 = (row, colIndex) => {
    // å–æ¶ˆå½“å‰è¡Œå…¶ä»–å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
    form.pEq01 = tablePEQ01
};

const tablePEQ2 = ref([
    { name: "ç‰¹æ–¯æ‹‰çš„ä¸“åˆ©å¼€æ”¾",selection: [false, false, false] },
    { name: "ä¸“åˆ©è®¸å¯å¤‡æ¡ˆåˆ¶åº¦",selection: [false, false, false] },
    { name: "ä¸“åˆ©è±å…",selection: [false, false, false] },
    { name: "ä¸“åˆ©å¼ºåˆ¶è®¸å¯åˆ¶åº¦",selection: [false, false, false] },
    { name: "ä¸“åˆ©å¼€æ”¾è®¸å¯åˆ¶åº¦",selection: [false, false, false] },
    { name: "è¯å“ä¸“åˆ©æ±  MPP", selection: [false, false, false] },
    { name: "åŒ»è¯ä¸“åˆ©é“¾æ¥åˆ¶åº¦", selection: [false, false, false] },
    { name: "æ ‡å‡†å¿…è¦ä¸“åˆ©", selection: [false, false, false] },
]);

const colPEQ2 = [
    { label: "å‚ä¸è¿‡" },
    { label: "äº†è§£ï¼Œæ²¡å‚ä¸è¿‡" },
    { label: "ä¸å¤ªäº†è§£" },
];

// å¤„ç†å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€å˜åŒ–
const handlePEQ2 = (row, colIndex) => {
    const rowIndex = tablePEQ2.value.indexOf(row);
    tableColChange(tablePEQ2.value,rowIndex,colIndex)    
    form.pEq02 = tablePEQ2
};

const tablePEQ3 = ref([
    { name: "å‚åŠ æå‡çŸ¥è¯†äº§æƒè¿è¥èƒ½åŠ›çš„åŸ¹è®­/å…¬ç›Šè®²åº§",rate: 0 },
    { name: "å‚åŠ çŸ¥è¯†äº§æƒè¿è¥æ”¿ç­–çš„æ”¿ç­–å’¨è¯¢è®²åº§", rate: 0 },
    { name: "å‚åŠ ä¸“åˆ©æŠ€æœ¯çš„è·¯æ¼”æ¨ä»‹æ´»åŠ¨", rate: 0 },
    { name: "ä½¿ç”¨å…¬å…±éƒ¨é—¨æ­å»ºçš„ä¸“åˆ©åœ¨çº¿äº¤æ˜“å¹³å°", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©è®¸å¯äº¤æ˜“çš„å®šä»·æŒ‡å¯¼", rate: 0 },
]);

const colPEQ3 = [
    { label: "æ²¡æœ‰-->è®¸å¤šæ¬¡" },
];

// å¤„ç†å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€å˜åŒ–
const handlePEQ03 = (row, colIndex) => {
    // å–æ¶ˆå½“å‰è¡Œå…¶ä»–å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
    form.pEq03 = tablePEQ3
};

const tablePEQ4 = ref([
    { name: "è·å¾—é«˜ä»·å€¼ä¸“åˆ©çš„å¥–åŠ±", rate: 0 },
    { name: "è·å¾—çŸ¥è¯†äº§æƒè¯•ç‚¹ç¤ºèŒƒé¡¹ç›®å¥–åŠ±", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©è½¬åŒ–æˆæœå¥–åŠ±", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©ç»­è´¹çš„å‡å…æˆ–è¡¥è´´", rate: 0 },
    { name: "äº«å—ç ”å‘è´¹ç”¨çš„åŠ è®¡æ‰£é™¤", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©è®¸å¯æ”¶ç›Šç›¸å…³çš„ç¨æ”¶å‡å…", rate: 0 },
]);

const colPEQ4 = [
    { label: "æ²¡æœ‰-->è®¸å¤šæ¬¡" },
];

// å¤„ç†å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€å˜åŒ–
const handlePEQ04 = (row, colIndex) => {
    // å–æ¶ˆå½“å‰è¡Œå…¶ä»–å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
    form.pEq04 = tablePEQ4
};

const tablePEQ5 = ref([
    { name: "ä¸¾åŠçŸ¥è¯†äº§æƒè¿è¥èƒ½åŠ›çš„åŸ¹è®­/å…¬ç›Šè®²åº§", rate: 0 },
    { name: "ä¸¾åŠçŸ¥è¯†äº§æƒè¿è¥æ”¿ç­–çš„æ”¿ç­–å’¨è¯¢è®²åº§", rate: 0 },
    { name: "å‘å¸ƒè¯¸å¦‚ã€Šä¸“åˆ©å¼€æ”¾è®¸å¯ä½¿ç”¨è´¹ä¼°ç®—æŒ‡å¼•ã€‹ç­‰æŒ‡å¯¼æ‰‹å†Œ", rate: 0 },
    { name: "ä¸¾åŠä¸“åˆ©æŠ€æœ¯çš„è·¯æ¼”æ¨ä»‹æ´»åŠ¨", rate: 0 },
    { name: "æä¾›ã€æ­å»ºä¸“åˆ©åœ¨çº¿äº¤æ˜“å¹³å°", rate: 0 },
    { name: "æä¾›ä¸“åˆ©è®¸å¯äº¤æ˜“çš„å…¬ç›Šæ€§å®šä»·æŒ‡å¯¼", rate: 0 },
    { name: "æä¾›ç»™é«˜ä»·å€¼ä¸“åˆ©çš„å¥–åŠ±", rate: 0 },
    { name: "æä¾›ä¸“åˆ©è½¬ç§»è½¬åŒ–æˆæœå¥–åŠ±", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©ç»­è´¹çš„å‡å…æˆ–è¡¥è´´", rate: 0 },
    { name: "äº«å—ç ”å‘è´¹ç”¨çš„åŠ è®¡æ‰£é™¤", rate: 0 },
    { name: "è·å¾—ä¸“åˆ©è®¸å¯æ”¶ç›Šç›¸å…³çš„ç¨æ”¶å‡å…", rate: 0 },
]);

const colPEQ5 = [
    { label: "ä¸ç”¨æé«˜-->å¤§å¹…æé«˜" },
];

// å¤„ç†å•å…ƒæ ¼é€‰ä¸­çŠ¶æ€å˜åŒ–
const handlePEQ05 = (row, colIndex) => {
    // å–æ¶ˆå½“å‰è¡Œå…¶ä»–å•å…ƒæ ¼çš„é€‰ä¸­çŠ¶æ€
    form.pEq05 = tablePEQ5
};
const changeTable = (table, col) => {
    let results = [];
    for (let i = 0; i < table.length; i++) {
        for (let j = 0; j < table[i].selection.length; j++) {
            if (table[i].selection[j]) {
                results.push({ row: table[i].name, col: col[j].label });
            }
        }
    }
    return results
}
const submit = async () => {
    // æ·±æ‹·è´
    let formData = JSON.parse(JSON.stringify(form));
    formData.pEq02=changeTable(formData.pEq02,colPEQ2)
    // å°†è¡¨å•æ•°æ®è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„
    const formDataArray = Object.entries(formData).map(([key, value]) => ({ [key]: value }));

    // å°†å¯¹è±¡æ•°ç»„å­—ç¬¦ä¸²åŒ–
    const formDataString = JSON.stringify(formDataArray);

    const patentNo = surveyInfo.patentNo

    console.log(patentNo)
    console.log(formDataString);


    const invitationCode = surveyInfo.curInvitationCode

    const data = {
        invitationCode: invitationCode,
        patentNo: patentNo,
        type: "ä¼ä¸š",
        policy: formDataString
    };
    let response = await axios.post('/api/survey/policy', data);
    if (response.status == 200) {
        if (response.data.code == 1) {
            ElMessage.success("submit successfully")
            dialogVisible.value = true
        }
    }
}
const submitAward = async () => {
    awardForm.patentNo = surveyInfo.patentNo
    dialogVisible.value = false
    console.log(awardForm)
    let response = await axios.post('/api/survey/award', awardForm);
    if (response.status == 200) {
        if (response.data.code == 1) {
            ElMessage.success("æˆåŠŸæäº¤å¥–åŠ±")
        } else{
            ElMessage.error("æ‚¨å·²é€‰æ‹©å¥–åŠ±")
        }
    }
    window.location.reload()
}
</script>

<style scoped>
:deep(.el-radio__label) {
    white-space: normal;
    /* æ¢è¡Œ */
}

:deep(.el-checkbox__label) {
    white-space: normal;
    /* æ¢è¡Œ */
}
.question {
    font-weight: bolder;
    font-family: SimSun;
}

.answer {
    font-family: KaiTi;
    margin-left: 2em;
}

.table-container {
    display: flex;
    margin-left: 2vw;
}
.table-container1 {
    display: flex;
    justify-content: center;

    align-items: center;

}
.el-table {
    margin-left: 2.5em;
    margin-top: 1vh;
}

::v-deep.el-table th {
    border: 1px solid rgb(105, 102, 102) !important;
    border-right: none !important;
    border-bottom: none !important;
    border-top: none !important;
    /* border-left: none !important; */
}

::v-deep.el-table td {
    border: 1px solid rgb(105, 102, 102);
    border-right: none !important;
    border-bottom: none !important;
    /* border-left: none !important; */
}

::v-deep .el-table {
    border-collapse: separate;
    border: none !important;
}

.ps{
    color: rgb(0,112,192);
}
::v-deep .el-form-item__label {
    font-size: 17px;

}
</style>
